{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/anthropics/agent-arborist/schemas/step-outputs.schema.json",
  "title": "Agent Arborist Step Output Schemas",
  "description": "JSON Schema definitions for step result outputs captured by Dagu",

  "definitions": {
    "StepResultBase": {
      "type": "object",
      "description": "Base fields present in all step results",
      "properties": {
        "success": {
          "type": "boolean",
          "description": "Whether the step completed successfully"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of when the step completed"
        },
        "error": {
          "type": ["string", "null"],
          "description": "Error message if step failed"
        }
      },
      "required": ["success", "timestamp"]
    },

    "PreSyncResult": {
      "allOf": [
        { "$ref": "#/definitions/StepResultBase" },
        {
          "type": "object",
          "description": "Result from task pre-sync step",
          "properties": {
            "worktree_path": {
              "type": "string",
              "description": "Path to the task's git worktree"
            },
            "branch": {
              "type": "string",
              "description": "Name of the task's branch"
            },
            "parent_branch": {
              "type": "string",
              "description": "Name of the parent branch synced from"
            },
            "created_worktree": {
              "type": "boolean",
              "description": "Whether a new worktree was created"
            },
            "synced_from_parent": {
              "type": "boolean",
              "description": "Whether changes were synced from parent branch"
            }
          }
        }
      ]
    },

    "RunResult": {
      "allOf": [
        { "$ref": "#/definitions/StepResultBase" },
        {
          "type": "object",
          "description": "Result from task run step (AI execution)",
          "properties": {
            "files_changed": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of files modified by the AI"
            },
            "commit_message": {
              "type": ["string", "null"],
              "description": "Commit message if AI created a commit"
            },
            "summary": {
              "type": "string",
              "description": "Truncated summary of AI output"
            },
            "runner": {
              "type": "string",
              "enum": ["claude", "opencode", "gemini"],
              "description": "AI runner used for execution"
            },
            "model": {
              "type": ["string", "null"],
              "description": "Model name/version used"
            },
            "duration_seconds": {
              "type": "number",
              "minimum": 0,
              "description": "Execution time in seconds"
            }
          }
        }
      ]
    },

    "CommitResult": {
      "allOf": [
        { "$ref": "#/definitions/StepResultBase" },
        {
          "type": "object",
          "description": "Result from task commit step",
          "properties": {
            "commit_sha": {
              "type": ["string", "null"],
              "pattern": "^[a-f0-9]{40}$",
              "description": "Full SHA of the commit"
            },
            "message": {
              "type": "string",
              "description": "Commit message (first line)"
            },
            "files_staged": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of files in the commit"
            },
            "was_fallback": {
              "type": "boolean",
              "description": "Whether this was a fallback commit (AI didn't commit)"
            }
          }
        }
      ]
    },

    "RunTestResult": {
      "allOf": [
        { "$ref": "#/definitions/StepResultBase" },
        {
          "type": "object",
          "description": "Result from task run-test step",
          "properties": {
            "test_command": {
              "type": ["string", "null"],
              "description": "Test command that was executed"
            },
            "test_count": {
              "type": ["integer", "null"],
              "minimum": 0,
              "description": "Total number of tests run"
            },
            "passed": {
              "type": ["integer", "null"],
              "minimum": 0,
              "description": "Number of tests passed"
            },
            "failed": {
              "type": ["integer", "null"],
              "minimum": 0,
              "description": "Number of tests failed"
            },
            "skipped": {
              "type": ["integer", "null"],
              "minimum": 0,
              "description": "Number of tests skipped"
            },
            "output_summary": {
              "type": "string",
              "description": "Truncated test output"
            }
          }
        }
      ]
    },

    "PostMergeResult": {
      "allOf": [
        { "$ref": "#/definitions/StepResultBase" },
        {
          "type": "object",
          "description": "Result from task post-merge step",
          "properties": {
            "merged_into": {
              "type": "string",
              "description": "Target branch of the merge"
            },
            "source_branch": {
              "type": "string",
              "description": "Source branch that was merged"
            },
            "commit_sha": {
              "type": ["string", "null"],
              "pattern": "^[a-f0-9]{40}$",
              "description": "SHA of the merge commit"
            },
            "conflicts": {
              "type": "array",
              "items": { "type": "string" },
              "description": "List of files that had conflicts (empty if resolved)"
            },
            "conflict_resolved": {
              "type": "boolean",
              "description": "Whether AI resolved merge conflicts"
            }
          }
        }
      ]
    },

    "PostCleanupResult": {
      "allOf": [
        { "$ref": "#/definitions/StepResultBase" },
        {
          "type": "object",
          "description": "Result from task post-cleanup step",
          "properties": {
            "worktree_removed": {
              "type": "boolean",
              "description": "Whether the worktree was removed"
            },
            "branch_deleted": {
              "type": "boolean",
              "description": "Whether the branch was deleted"
            },
            "cleaned_up": {
              "type": "boolean",
              "description": "Whether cleanup completed successfully"
            }
          }
        }
      ]
    }
  }
}
