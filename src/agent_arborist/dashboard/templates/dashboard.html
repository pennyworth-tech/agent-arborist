<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arborist Dashboard</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --text: #e6edf3; --text-dim: #8b949e; --green: #3fb950;
    --green-dim: #238636; --yellow: #d29922; --red: #f85149;
    --cyan: #58a6ff; --purple: #bc8cff; --orange: #d18616;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg); color: var(--text);
    padding: 24px; line-height: 1.5;
  }
  h1 { font-size: 24px; font-weight: 600; margin-bottom: 4px; }
  h2 { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-dim); }
  .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .subtitle { color: var(--text-dim); font-size: 14px; margin-bottom: 24px; }
  .refresh-info { font-size: 12px; color: var(--text-dim); }
  .refresh-btn {
    background: var(--green-dim); color: var(--text); border: none; border-radius: 6px;
    padding: 6px 14px; cursor: pointer; font-size: 13px; margin-left: 8px;
  }
  .refresh-btn:hover { background: var(--green); }
  .auto-label { font-size: 12px; color: var(--text-dim); margin-left: 8px; }
  .grid { display: grid; gap: 16px; margin-bottom: 24px; }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 16px;
  }
  .stat-value { font-size: 32px; font-weight: 700; }
  .stat-label { font-size: 13px; color: var(--text-dim); }
  .progress-outer {
    background: var(--border); border-radius: 6px; height: 12px;
    overflow: hidden; margin: 8px 0;
  }
  .progress-inner { height: 100%; border-radius: 6px; transition: width 0.5s ease; }

  .tabs { display: flex; gap: 2px; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
  .tab {
    padding: 8px 16px; cursor: pointer; font-size: 13px; font-weight: 500;
    color: var(--text-dim); border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--text); border-bottom-color: var(--cyan); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .group {
    border-bottom: 1px solid var(--border); padding: 8px 0;
  }
  .group:last-child { border-bottom: none; }
  .group-header {
    display: flex; align-items: center; gap: 8px; cursor: pointer;
    user-select: none; padding: 4px 0;
  }
  .group-header:hover { opacity: 0.85; }
  .group-toggle {
    font-size: 11px; color: var(--text-dim); width: 16px; text-align: center;
    transition: transform 0.2s;
  }
  .group-toggle.collapsed { transform: rotate(-90deg); }
  .group-id { font-weight: 600; font-size: 13px; color: var(--cyan); min-width: 50px; }
  .group-name { font-size: 13px; font-weight: 500; flex: 1; }
  .group-tasks { }
  .group-tasks.hidden { display: none !important; }
  .group-progress { font-size: 12px; color: var(--text-dim); }
  .task {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 6px 0; border-bottom: 1px solid #21262d;
    font-size: 13px;
  }
  .task:last-child { border-bottom: none; }
  .task-icon { min-width: 18px; text-align: center; font-size: 14px; padding-top: 1px; }
  .task-id { font-family: monospace; font-size: 12px; min-width: 38px; color: var(--text-dim); }
  .task-name { flex: 1; line-height: 1.4; }
  .task-name.done { color: var(--text-dim); }
  .badge {
    padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;
  }
  .badge-pass { background: #238636; color: #e6edf3; }
  .badge-pending { background: #30363d; color: #8b949e; }
  .badge-active { background: #0c2d6b; color: var(--cyan); }
  .badge-retry { background: #d18616; color: #e6edf3; }

  .gantt { position: relative; overflow-x: auto; }
  .gantt-row { display: flex; align-items: center; height: 28px; gap: 8px; }
  .gantt-label { font-size: 12px; font-family: monospace; min-width: 40px; color: var(--text-dim); }
  .gantt-track { flex: 1; position: relative; height: 20px; }
  .gantt-bar {
    position: absolute; height: 16px; top: 2px; border-radius: 3px;
    min-width: 4px; cursor: pointer;
  }
  .gantt-bar:hover { filter: brightness(1.3); }
  .gantt-bar.implement { background: var(--cyan); opacity: 0.7; }
  .gantt-bar.review { background: var(--purple); opacity: 0.7; }
  .gantt-bar.test { background: var(--yellow); opacity: 0.7; }
  .gantt-bar.retry-attempt { border: 2px solid var(--orange); }
  .legend { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-dim); }
  .legend-dot { width: 12px; height: 12px; border-radius: 3px; }

  /* Commit detail modal */
  .commit-list { list-style: none; padding: 0; margin: 0; }
  .commit-item { padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .commit-item:last-child { border-bottom: none; }
  .commit-sha { font-family: monospace; color: var(--cyan); font-size: 12px; }
  .commit-subject { margin-left: 8px; }
  .commit-trailers { font-size: 11px; color: var(--text-dim); margin-top: 2px; padding-left: 16px; }

  @media (max-width: 768px) {
    .grid-2, .grid-4 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="header-row">
  <div>
    <h1>Arborist Dashboard</h1>
    <div class="subtitle" id="subtitle">Loading...</div>
  </div>
  <div style="display:flex;align-items:center;">
    <span class="refresh-info" id="refresh-info"></span>
    <button class="refresh-btn" onclick="fetchAndRender()">Refresh</button>
    <label class="auto-label">
      <input type="checkbox" id="auto-refresh" checked> Auto (5s)
    </label>
  </div>
</div>

<div class="grid grid-4" id="stats"></div>

<div class="card" style="margin-bottom: 16px;">
  <h2>Overall Progress</h2>
  <div id="overall-progress"></div>
</div>

<div class="card" style="margin-top: 16px;">
  <div class="tabs">
    <div class="tab active" onclick="switchTab('tree')">Task Tree</div>
    <div class="tab" onclick="switchTab('gantt')">Timeline</div>
  </div>
  <div class="tab-content active" id="tab-tree">
    <div id="full-tree"></div>
  </div>
  <div class="tab-content" id="tab-gantt">
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--cyan);"></div> Implement</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--purple);"></div> Review</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--yellow);"></div> Test</div>
      <div class="legend-item"><div class="legend-dot" style="border:2px solid var(--orange);background:transparent;"></div> Retry attempt</div>
    </div>
    <div class="gantt" id="gantt"></div>
  </div>
</div>

<!-- Detail Modal (log files + commit info) -->
<div id="detail-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;justify-content:center;align-items:center;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;width:80%;max-width:1000px;height:80%;display:flex;flex-direction:column;">
    <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <div style="display:flex;flex-direction:column;gap:8px;">
        <h3 id="detail-modal-title" style="font-size:16px;margin:0;">Details</h3>
        <div id="detail-selector" style="display:none;"></div>
      </div>
      <button onclick="closeDetailModal()" style="background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;">&times;</button>
    </div>
    <pre id="detail-content" style="flex:1;overflow:auto;padding:16px;margin:0;font-family:monospace;font-size:12px;line-height:1.4;white-space:pre-wrap;word-wrap:break-word;"></pre>
  </div>
</div>

<script>
let autoRefreshInterval = null;
let currentTab = localStorage.getItem('arborist-tab') || 'tree';
let currentStatus = null;
let currentLogs = {};

function switchTab(tabId) {
  currentTab = tabId;
  localStorage.setItem('arborist-tab', tabId);
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const tabEl = document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`);
  const contentEl = document.getElementById('tab-' + tabId);
  if (tabEl) tabEl.classList.add('active');
  if (contentEl) contentEl.classList.add('active');
}

function startAutoRefresh() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(fetchAndRender, 5000);
}

function stopAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
}

document.getElementById('auto-refresh').addEventListener('change', () => {
  if (document.getElementById('auto-refresh').checked) startAutoRefresh();
  else stopAutoRefresh();
});

function getCommitCounts(taskData) {
  const commits = taskData.commits || [];
  return {
    implement: commits.filter(c => c.step === 'implement').length,
    review: commits.filter(c => c.step === 'review').length,
    test: commits.filter(c => c.step === 'test').length,
  };
}

function getMaxRetry(taskData) {
  const commits = taskData.commits || [];
  let max = 0;
  for (const c of commits) {
    const r = parseInt(c.retry);
    if (!isNaN(r) && r > max) max = r;
  }
  return max;
}

async function fetchAndRender() {
  const btn = document.querySelector('.refresh-btn');
  const info = document.getElementById('refresh-info');
  btn.textContent = 'Refreshing...';
  btn.style.opacity = '0.6';
  info.textContent = 'Fetching...';
  try {
    const [statusResp, reportsResp, logsResp] = await Promise.all([
      fetch('/api/status?t=' + Date.now()),
      fetch('/api/reports?t=' + Date.now()),
      fetch('/api/logs?t=' + Date.now()),
    ]);
    const status = await statusResp.json();
    const reports = await reportsResp.json();
    const logsData = await logsResp.json();
    currentStatus = status;
    currentLogs = logsData.logs || {};

    render(status, reports);
    info.textContent = 'Updated ' + new Date().toLocaleTimeString();
    document.body.style.transition = 'background 0.15s';
    document.body.style.background = '#111820';
    setTimeout(() => { document.body.style.background = 'var(--bg)'; }, 150);
  } catch (e) {
    info.textContent = 'Error: ' + e.message;
    info.style.color = 'var(--red)';
    setTimeout(() => { info.style.color = ''; }, 3000);
  }
  btn.textContent = 'Refresh';
  btn.style.opacity = '1';
}

function render(status, reports) {
  const reportMap = {};
  reports.reports.forEach(r => reportMap[r.task_id] = r);

  const leafTasks = Object.entries(status.tasks).filter(([id, task]) => {
    const node = status.tree.nodes[id];
    return node && !node.children || node.children.length === 0;
  });

  const totalTasks = leafTasks.length;
  const completedTasks = leafTasks.filter(([id]) => reportMap[id]).length;

  // Count retried tasks from commit data
  let retriedCount = 0;
  for (const [id, task] of leafTasks) {
    if (reportMap[id] && getMaxRetry(task) > 0) retriedCount++;
  }
  const reportRetried = Object.values(reportMap).filter(r => r.retries > 0).length;

  document.getElementById('subtitle').textContent =
    status.branch + ' \u2014 Generated ' + new Date(status.generated_at).toLocaleTimeString();

  document.getElementById('stats').innerHTML = [
    { value: `${completedTasks}/${totalTasks}`, label: 'Tasks Completed', color: 'var(--green)' },
    { value: `${Math.round(completedTasks/totalTasks*100 || 0)}%`, label: 'Progress', color: 'var(--cyan)' },
    { value: `${retriedCount}`, label: `Retried (${reportRetried} per report)`, color: retriedCount > 0 ? 'var(--orange)' : 'var(--green)' },
    { value: `${totalTasks}`, label: 'Total Leaf Tasks', color: 'var(--text)' },
  ].map(s => `
    <div class="card">
      <div class="stat-value" style="color:${s.color}">${s.value}</div>
      <div class="stat-label">${s.label}</div>
    </div>
  `).join('');

  const pct = totalTasks > 0 ? Math.round(completedTasks / totalTasks * 100) : 0;
  document.getElementById('overall-progress').innerHTML = `
    <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;">
      <span>${completedTasks} of ${totalTasks} tasks</span><span>${pct}%</span>
    </div>
    <div class="progress-outer">
      <div class="progress-inner" style="width:${pct}%;background:var(--green);"></div>
    </div>
  `;

  document.getElementById('full-tree').innerHTML = renderFullTree(status.tree.root_ids, status.tree, status.tasks, reportMap, 0);

  renderGantt(status.tasks);
}

function getGroupState(nodeId) {
  const state = localStorage.getItem('arborist-group-' + nodeId);
  return state === 'true';
}

function renderFullTree(nodeIds, tree, tasks, reportMap, level) {
  return nodeIds.map(nodeId => {
    const node = tree.nodes[nodeId];
    const isLeaf = !node.children || node.children.length === 0;

    if (isLeaf) {
      const task = tasks[nodeId] || { name: node.name, commits: [] };
      const isDone = !!reportMap[nodeId];
      const hasCommits = task.commits && task.commits.length > 0;
      const isActive = !isDone && hasCommits;
      const counts = getCommitCounts(task);
      const maxRetry = getMaxRetry(task);
      const hadRetry = maxRetry > 0;

      let icon, badge, nameClass;
      if (isDone) {
        icon = '<span style="color:var(--green)">&#10003;</span>';
        badge = hadRetry
          ? `<span class="badge badge-retry">${maxRetry} retry</span>`
          : `<span class="badge badge-pass">pass</span>`;
        nameClass = 'task-name done';
      } else if (isActive) {
        icon = '<span style="color:var(--cyan)">&#9654;</span>';
        badge = '<span class="badge badge-active">running</span>';
        nameClass = 'task-name';
      } else {
        icon = '<span style="color:var(--text-dim)">&#9675;</span>';
        badge = '<span class="badge badge-pending">pending</span>';
        nameClass = 'task-name';
      }

      const implBtn = counts.implement > 0
        ? `<button onclick="viewPhaseCommits('${nodeId}', 'implement')" style="background:${getPhaseColor(counts.implement)};border:none;cursor:pointer;font-size:11px;padding:4px 8px;border-radius:4px;color:var(--bg);">implement ${counts.implement}</button>`
        : `<span style="font-size:11px;color:var(--text-dim);padding:4px 8px;">implement 0</span>`;
      const reviewBtn = counts.review > 0
        ? `<button onclick="viewPhaseCommits('${nodeId}', 'review')" style="background:${getPhaseColor(counts.review)};border:none;cursor:pointer;font-size:11px;padding:4px 8px;border-radius:4px;color:var(--bg);">review ${counts.review}</button>`
        : `<span style="font-size:11px;color:var(--text-dim);padding:4px 8px;">review 0</span>`;
      const testBtn = counts.test > 0
        ? `<button onclick="viewPhaseCommits('${nodeId}', 'test')" style="background:${getPhaseColor(counts.test)};border:none;cursor:pointer;font-size:11px;padding:4px 8px;border-radius:4px;color:var(--bg);">test ${counts.test}</button>`
        : '';

      return `<div class="task" style="padding-left:${level * 26 + 10}px;">
        <span class="task-icon">${icon}</span>
        <span class="task-id">${nodeId}</span>
        <span class="${nameClass}">${task.name}</span>
        <div style="margin-left:8px;display:flex;gap:4px;align-items:center;">
          ${implBtn}
          ${reviewBtn}
          ${testBtn}
        </div>
      </div>`;
    } else {
      const done = node.children.filter(cid => reportMap[cid]).length;
      const total = node.children.length;
      const isExpanded = getGroupState(nodeId);
      const toggleClass = isExpanded ? '' : 'collapsed';
      const tasksStyle = isExpanded ? '' : 'display:none;';
      const tasksHidden = isExpanded ? '' : 'hidden';
      return `<div class="group">
        <div class="group-header" onclick="toggleGroup(this)" style="padding-left:${level * 26}px;">
          <span class="group-toggle ${toggleClass}">â–¼</span>
          <span class="group-id">${nodeId}</span>
          <span class="group-name">${node.name}</span>
          <span class="group-progress">${done}/${total}</span>
        </div>
        <div class="group-tasks ${tasksHidden}" style="${tasksStyle}">
          ${renderFullTree(node.children, tree, tasks, reportMap, level + 1)}
        </div>
      </div>`;
    }
  }).join('');
}

function toggleGroup(header) {
  const toggle = header.querySelector('.group-toggle');
  const tasks = header.nextElementSibling;
  const idSpan = header.querySelector('.group-id');
  const nodeId = idSpan ? idSpan.textContent : null;
  const isCollapsed = toggle.classList.contains('collapsed');

  if (isCollapsed) {
    toggle.classList.remove('collapsed');
    tasks.classList.remove('hidden');
    tasks.style.display = '';
    if (nodeId) localStorage.setItem('arborist-group-' + nodeId, 'true');
  } else {
    toggle.classList.add('collapsed');
    tasks.classList.add('hidden');
    tasks.style.display = 'none';
    if (nodeId) localStorage.setItem('arborist-group-' + nodeId, 'false');
  }
}

function renderGantt(tasks) {
  // Build timeline from commit data - use commit order as proxy for time
  const taskEntries = {};
  for (const [taskId, task] of Object.entries(tasks)) {
    const commits = task.commits || [];
    if (commits.length === 0) continue;
    taskEntries[taskId] = commits.map(c => ({
      step: c.step,
      retry: parseInt(c.retry) || 0,
      sha: c.sha,
      subject: c.subject,
    }));
  }

  const taskIds = Object.keys(taskEntries);
  if (taskIds.length === 0) {
    document.getElementById('gantt').innerHTML = '<p style="color:var(--text-dim);padding:16px;">No timeline data available</p>';
    return;
  }

  // Assign sequential index to each commit across all tasks for positioning
  let totalCommits = 0;
  for (const entries of Object.values(taskEntries)) totalCommits += entries.length;

  let html = '';
  for (const taskId of taskIds) {
    const entries = taskEntries[taskId];
    // Commits are returned newest-first from git log, reverse for timeline
    const reversed = [...entries].reverse();

    html += `<div class="gantt-row">
      <span class="gantt-label">${taskId}</span>
      <div class="gantt-track">`;

    const total = reversed.length;
    for (let i = 0; i < reversed.length; i++) {
      const entry = reversed[i];
      const pct = total > 1 ? (i / (total - 1)) * 90 : 0;
      const isRetry = entry.retry > 0;
      const stepClass = ['implement', 'review', 'test'].includes(entry.step) ? entry.step : 'implement';
      html += `<div class="gantt-bar ${stepClass} ${isRetry ? 'retry-attempt' : ''}"
        style="left:${pct}%;width:30px;"
        title="${taskId} - ${entry.step} (attempt ${entry.retry + 1})\\n${entry.sha}: ${entry.subject}"
      ></div>`;
    }

    html += `</div></div>`;
  }

  document.getElementById('gantt').innerHTML = html;
}

function viewPhaseCommits(taskId, phase) {
  if (!currentStatus) return;
  const task = currentStatus.tasks[taskId];
  if (!task) return;

  const modal = document.getElementById('detail-modal');
  const title = document.getElementById('detail-modal-title');
  const content = document.getElementById('detail-content');
  const selector = document.getElementById('detail-selector');

  // Check for log files first
  const taskLogs = currentLogs[taskId] || [];
  const phaseLogs = taskLogs.filter(l => l.phase === phase);

  if (phaseLogs.length > 0) {
    // Show log file content
    modal.style.display = 'flex';
    if (phaseLogs.length === 1) {
      title.textContent = `${taskId} - ${phase}`;
      selector.style.display = 'none';
      loadLogContent(phaseLogs[0].filename);
    } else {
      title.textContent = `${taskId} - ${phase} (${phaseLogs.length} runs)`;
      selector.style.display = 'block';
      selector.innerHTML = `
        <select onchange="loadLogContent(this.value)" style="background:var(--surface);color:var(--text);border:1px solid var(--border);padding:8px;border-radius:4px;width:200px;">
          ${phaseLogs.map((l, i) => `<option value="${l.filename}">Run ${i + 1} - ${l.timestamp}</option>`).join('')}
        </select>
      `;
      loadLogContent(phaseLogs[0].filename);
    }
    return;
  }

  // Fallback: show commit details
  const commits = (task.commits || []).filter(c => c.step === phase);
  if (commits.length === 0) return;

  modal.style.display = 'flex';
  selector.style.display = 'none';
  title.textContent = `${taskId} - ${phase} (${commits.length} commits, no log files)`;

  let text = '';
  for (const c of commits) {
    text += `=== ${c.sha} ===\n${c.subject}\n`;
    for (const [k, v] of Object.entries(c.trailers || {})) {
      text += `  ${k}: ${v}\n`;
    }
    text += '\n';
  }
  content.textContent = text;
}

async function loadLogContent(filename) {
  const content = document.getElementById('detail-content');
  content.textContent = 'Loading...';
  try {
    const resp = await fetch(`/api/log/${filename}`);
    if (!resp.ok) throw new Error('Failed to load log');
    content.textContent = await resp.text();
  } catch (e) {
    content.textContent = 'Error loading log: ' + e.message;
  }
}

function closeDetailModal() {
  document.getElementById('detail-modal').style.display = 'none';
}

function getPhaseColor(count) {
  if (count === 0) return 'var(--text-dim)';
  if (count === 1) return 'var(--green)';
  if (count <= 4) return 'var(--yellow)';
  return 'var(--red)';
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeDetailModal();
});

document.getElementById('detail-modal').addEventListener('click', (e) => {
  if (e.target.id === 'detail-modal') closeDetailModal();
});

switchTab(currentTab);
startAutoRefresh();
fetchAndRender();
</script>
</body>
</html>
